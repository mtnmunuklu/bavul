package util

import (
	"errors"
	"regexp"
	"strings"
	"time"

	"golang.org/x/text/cases"
	"golang.org/x/text/language"
)

// Contains error codes for authentication service.
var (
	ErrInvalidCVEId          = errors.New("invalid cve id")
	ErrInvalidSecurityLevel  = errors.New("invalid security level")
	ErrEmptyCVEId            = errors.New("cve id can't be empty")
	ErrExistCVE              = errors.New("cve already exist")
	ErrNotFoundCVE           = errors.New("cve could not be found")
	ErrAddCVE                = errors.New("cve could not be created")
	ErrDeleteCVE             = errors.New("cve could not be deleted")
	ErrUpdateCVE             = errors.New("cve could not be updated")
	ErrNotPerformedOperation = errors.New("operation could not be performed")
)

// ValidateCVEId validates the CVE id.
func ValidateCVEId(cveId string) (string, error) {
	cveId = NormalizeCVEId(cveId)

	if cveId == "" {
		return "", ErrEmptyCVEId
	} else if !IsValidCVE(cveId) {
		return "", ErrInvalidCVEId
	}

	//TODO: Check CVE id is real or not

	return cveId, nil
}

// NormalizeCVEId normalizes the CVE id.
func NormalizeCVEId(cveId string) string {
	return strings.TrimSpace(cveId)
}

// isValidCVE checks if the given string is a valid CVE ID
func IsValidCVE(cveID string) bool {
	// Regular expression pattern to validate CVE ID
	cvePattern := `^CVE-\d{4}-\d{4,}$`

	// Compile the regex pattern
	r := regexp.MustCompile(cvePattern)

	// Check the pattern
	return r.MatchString(cveID)
}

func ParseTime(dateStr string) time.Time {
	layout := "2006-01-02T15:04:05.000"
	t, err := time.Parse(layout, dateStr)
	if err != nil {
		return time.Time{}
	}
	return t
}

func FormatTime(t time.Time) string {
	layout := "2006-01-02T15:04:05.000"
	return t.Format(layout)
}

// CheckSeverity function checks if the given string is a valid severity value ("None", "Low", "Medium", "High", "Critical").
// If valid, it converts the string to a format starting with an uppercase letter.
// If not valid, it returns an error.
func CheckSeverity(severity string) (string, error) {
	// Create a title case converter
	titleCase := cases.Title(language.English)

	// Convert the string to title case
	severity = titleCase.String(severity)

	// Check for valid severity values
	switch severity {
	case "None", "Low", "Medium", "High", "Critical":
		return severity, nil
	default:
		return "", ErrInvalidSecurityLevel
	}
}
